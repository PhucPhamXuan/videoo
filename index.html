<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Ch·∫°y video tr√° h√¨nh t·ª´ PNG ch·ª©a TS</title>
</head>
<body>
  <h2>üé¨ Convert TS (trong PNG) ‚Üí MP4 ngay tr√™n tr√¨nh duy·ªát</h2>
  <video id="player" width="640" height="360" controls autoplay></video>

  <!-- ‚úÖ ƒê√¢y l√† b·∫£n chu·∫©n d√πng trong tr√¨nh duy·ªát -->
  <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.10.1/dist/ffmpeg.min.js"></script>

  <script>
    // üß† FFmpeg g·∫Øn tr√™n global `window.FFmpeg`
    const { createFFmpeg, fetchFile } = window.FFmpeg;
    const ffmpeg = createFFmpeg({ log: true });

    const BASE_URL = "https://raw.githubusercontent.com/phucphamxuan/video/main/";
    const HEADER_FILE = "header.png";
    const SEGMENT = "out000.png"; // Thay ƒë·ªïi t·∫°i ƒë√¢y n·∫øu mu·ªën test ƒëo·∫°n kh√°c

    async function main() {
      const video = document.getElementById("player");

      // 1. Fetch header ƒë·ªÉ t√≠nh k√≠ch th∆∞·ªõc
      const headerRes = await fetch(BASE_URL + HEADER_FILE);
      const headerBuf = await headerRes.arrayBuffer();
      const HEADER_SIZE = headerBuf.byteLength;
      console.log("üì¶ HEADER_SIZE:", HEADER_SIZE);

      // 2. Fetch PNG ch·ª©a TS
      const res = await fetch(BASE_URL + SEGMENT);
      const pngBuf = await res.arrayBuffer();
      const tsBuf = pngBuf.slice(HEADER_SIZE);

      // 3. Load ffmpeg.wasm
      if (!ffmpeg.isLoaded()) await ffmpeg.load();

      // 4. Ghi file v√†o h·ªá th·ªëng ·∫£o
      ffmpeg.FS('writeFile', 'input.ts', new Uint8Array(tsBuf));

      // 5. Convert TS ‚Üí MP4
      await ffmpeg.run(
        '-i', 'input.ts',
        '-c', 'copy',
        '-f', 'mp4',
        '-movflags', 'frag_keyframe+empty_moov',
        'output.mp4'
      );

      // 6. ƒê·ªçc file MP4 ƒë√£ x·ª≠ l√Ω
      const outData = ffmpeg.FS('readFile', 'output.mp4');

      // 7. T·∫°o Blob v√† ph√°t
      const blob = new Blob([outData.buffer], { type: 'video/mp4' });
      const url = URL.createObjectURL(blob);
      video.src = url;
    }

    main();
  </script>
</body>
</html>
