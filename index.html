<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>üé¨ Video Player</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #000;
      color: #fff;
      overflow: hidden;
    }
    
    .player-container {
      position: relative;
      width: 100vw;
      height: 100vh;
      background: #000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .video-wrapper {
      position: relative;
      width: 100%;
      height: 100%;
      max-width: 1920px;
      max-height: 1080px;
    }
    
    video {
      width: 100%;
      height: 100%;
      object-fit: contain;
      background: #000;
    }
    
    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 100;
      backdrop-filter: blur(10px);
    }
    
    .play-button {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.1);
      border: 3px solid rgba(255, 255, 255, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-bottom: 30px;
    }
    
    .play-button:hover {
      background: rgba(255, 255, 255, 0.2);
      border-color: rgba(255, 255, 255, 0.5);
      transform: scale(1.1);
    }
    
    .play-button svg {
      width: 40px;
      height: 40px;
      fill: white;
      margin-left: 5px;
    }
    
    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(255, 255, 255, 0.1);
      border-top: 4px solid #e50914;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-text {
      font-size: 18px;
      font-weight: 500;
      margin-bottom: 15px;
      text-align: center;
    }
    
    .progress-bar {
      width: 400px;
      height: 6px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 3px;
      overflow: hidden;
      margin-bottom: 10px;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #e50914, #ff6b6b);
      transition: width 0.3s ease;
      border-radius: 3px;
    }
    
    .progress-text {
      font-size: 14px;
      color: rgba(255, 255, 255, 0.8);
      text-align: center;
    }
    
    .buffer-indicator {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.7);
      padding: 8px 12px;
      border-radius: 20px;
      font-size: 12px;
      backdrop-filter: blur(10px);
      z-index: 200;
    }
    
    .buffer-indicator.ready {
      background: rgba(0, 150, 0, 0.8);
    }
    
    .error-message {
      color: #ff4444;
      font-size: 16px;
      text-align: center;
      margin-top: 20px;
      padding: 15px;
      background: rgba(255, 68, 68, 0.1);
      border-radius: 8px;
      border: 1px solid rgba(255, 68, 68, 0.3);
    }
    
    .video-title {
      position: absolute;
      top: 20px;
      left: 20px;
      font-size: 24px;
      font-weight: 600;
      z-index: 200;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
    }
    
    .speed-indicator {
      position: absolute;
      bottom: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.7);
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 11px;
      backdrop-filter: blur(10px);
      z-index: 200;
    }
    
    .controls-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
      padding: 60px 20px 20px;
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 150;
    }
    
    .player-container:hover .controls-overlay {
      opacity: 1;
    }
    
    .control-buttons {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 15px;
    }
    
    .control-btn {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      transition: background 0.2s;
    }
    
    .control-btn:hover {
      background: rgba(255, 255, 255, 0.1);
    }
    
    .control-btn svg {
      width: 20px;
      height: 20px;
      fill: currentColor;
    }
    
    .time-display {
      font-size: 14px;
      color: rgba(255, 255, 255, 0.9);
      margin-left: auto;
    }
    
    .video-progress {
      width: 100%;
      height: 4px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 2px;
      cursor: pointer;
      position: relative;
    }
    
    .video-progress-fill {
      height: 100%;
      background: #e50914;
      border-radius: 2px;
      transition: width 0.1s ease;
    }
    
    .hidden {
      display: none !important;
    }
    
    @media (max-width: 768px) {
      .progress-bar {
        width: 300px;
      }
      
      .video-title {
        font-size: 20px;
      }
      
      .play-button {
        width: 100px;
        height: 100px;
      }
      
      .play-button svg {
        width: 35px;
        height: 35px;
      }
    }
  </style>
</head>
<body>
  <div class="player-container">
    <div class="video-title">üé¨ Video Player</div>
    
    <div class="buffer-indicator" id="bufferIndicator">
      ƒêang t·∫£i...
    </div>
    
    <div class="speed-indicator" id="speedIndicator">
      0 MB/s
    </div>
    
    <div class="video-wrapper">
      <video id="videoPlayer" poster="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iIzAwMCIvPjx0ZXh0IHg9IjUwIiB5PSI1MCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSIjZmZmIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+VmlkZW88L3RleHQ+PC9zdmc+"></video>
      
      <div class="loading-overlay" id="loadingOverlay">
        <div class="play-button" id="playButton">
          <svg viewBox="0 0 24 24">
            <path d="M8 5v14l11-7z"/>
          </svg>
        </div>
        
        <div class="loading-content" id="loadingContent" style="display: none;">
          <div class="loading-spinner"></div>
          <div class="loading-text" id="loadingText">ƒêang t·∫£i video...</div>
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
          </div>
          <div class="progress-text" id="progressText">0%</div>
        </div>
        
        <div class="error-message hidden" id="errorMessage">
          C√≥ l·ªói x·∫£y ra khi t·∫£i video. Vui l√≤ng th·ª≠ l·∫°i.
        </div>
      </div>
      
      <div class="controls-overlay">
        <div class="control-buttons">
          <button class="control-btn" id="playPauseBtn">
            <svg viewBox="0 0 24 24">
              <path d="M8 5v14l11-7z"/>
            </svg>
          </button>
          
          <button class="control-btn" id="muteBtn">
            <svg viewBox="0 0 24 24">
              <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
            </svg>
          </button>
          
          <div class="time-display" id="timeDisplay">
            00:00 / 00:00
          </div>
        </div>
        
        <div class="video-progress" id="videoProgress">
          <div class="video-progress-fill" id="videoProgressFill"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.10.1/dist/ffmpeg.min.js"></script>
  <script>
    const { createFFmpeg, fetchFile } = window.FFmpeg;
    
    // Kh·ªüi t·∫°o FFmpeg
    const ffmpeg = createFFmpeg({ 
      log: false,
      corePath: 'https://unpkg.com/@ffmpeg/core@0.10.0/dist/ffmpeg-core.js'
    });

    // C·∫•u h√¨nh t·∫£i c·ª±c nhanh cho m·∫°ng 40Mbps
    const CONFIG = {
      BASE_URL: "https://raw.githubusercontent.com/phucphamxuan/video/main/",
      HEADER_FILE: "header.png",
      TOTAL_SEGMENTS: 521,
      MAX_CONCURRENT: 16,        // TƒÉng l√™n 16 lu·ªìng
      REQUEST_DELAY: 50,         // Gi·∫£m delay xu·ªëng 50ms
      RETRY_DELAY: 300,
      MAX_RETRIES: 2,
      INITIAL_BUFFER: 30,        // T·∫£i 30 segment ƒë·∫ßu ƒë·ªÉ ph√°t
      LOOKAHEAD_BUFFER: 20       // T·∫£i tr∆∞·ªõc 20 segment
    };

    // State qu·∫£n l√Ω
    let videoState = {
      isLoading: false,
      isPlaying: false,
      headerSize: 0,
      segments: new Array(CONFIG.TOTAL_SEGMENTS),
      bufferedCount: 0,
      currentSegment: 0,
      downloadStats: {
        totalBytes: 0,
        startTime: 0,
        successCount: 0,
        failCount: 0
      }
    };

    // DOM elements
    const elements = {
      video: document.getElementById('videoPlayer'),
      loadingOverlay: document.getElementById('loadingOverlay'),
      playButton: document.getElementById('playButton'),
      loadingContent: document.getElementById('loadingContent'),
      progressFill: document.getElementById('progressFill'),
      progressText: document.getElementById('progressText'),
      loadingText: document.getElementById('loadingText'),
      bufferIndicator: document.getElementById('bufferIndicator'),
      speedIndicator: document.getElementById('speedIndicator'),
      errorMessage: document.getElementById('errorMessage'),
      playPauseBtn: document.getElementById('playPauseBtn'),
      timeDisplay: document.getElementById('timeDisplay'),
      videoProgress: document.getElementById('videoProgress'),
      videoProgressFill: document.getElementById('videoProgressFill')
    };

    // Utility functions
    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    function formatBytes(bytes) {
      const mb = bytes / (1024 * 1024);
      return mb.toFixed(1) + ' MB';
    }

    function formatSpeed(bytesPerSecond) {
      const mbps = (bytesPerSecond * 8) / (1024 * 1024);
      return mbps.toFixed(1) + ' Mbps';
    }

    // T·∫£i header
    async function loadHeader() {
      try {
        const response = await fetch(CONFIG.BASE_URL + CONFIG.HEADER_FILE);
        if (!response.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i header');
        
        const buffer = await response.arrayBuffer();
        videoState.headerSize = buffer.byteLength;
        
        console.log('Header loaded:', videoState.headerSize, 'bytes');
      } catch (error) {
        console.error('L·ªói t·∫£i header:', error);
        throw error;
      }
    }

    // T·∫£i segment ƒë∆°n l·∫ª v·ªõi retry
    async function downloadSegment(index, retries = 0) {
      const filename = `out${index.toString().padStart(3, '0')}.png`;
      
      try {
        const startTime = Date.now();
        const response = await fetch(CONFIG.BASE_URL + filename);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const buffer = await response.arrayBuffer();
        const downloadTime = Date.now() - startTime;
        
        // C·∫≠p nh·∫≠t stats
        videoState.downloadStats.totalBytes += buffer.byteLength;
        videoState.downloadStats.successCount++;
        
        // Extract TS data (b·ªè header)
        const tsData = buffer.slice(videoState.headerSize);
        return new Uint8Array(tsData);
        
      } catch (error) {
        if (retries < CONFIG.MAX_RETRIES) {
          await new Promise(resolve => setTimeout(resolve, CONFIG.RETRY_DELAY));
          return downloadSegment(index, retries + 1);
        }
        
        videoState.downloadStats.failCount++;
        console.error(`L·ªói t·∫£i segment ${index}:`, error);
        throw error;
      }
    }

    // Qu·∫£n l√Ω t·∫£i ƒëa lu·ªìng
    class DownloadManager {
      constructor() {
        this.downloadQueue = [];
        this.activeDownloads = new Set();
        this.isRunning = false;
      }

      async start() {
        if (this.isRunning) return;
        this.isRunning = true;
        
        // T·∫°o initial queue (30 segment ƒë·∫ßu)
        for (let i = 0; i < CONFIG.INITIAL_BUFFER; i++) {
          this.downloadQueue.push(i);
        }
        
        // Kh·ªüi ƒë·ªông workers
        const workers = [];
        for (let i = 0; i < CONFIG.MAX_CONCURRENT; i++) {
          workers.push(this.worker());
        }
        
        await Promise.all(workers);
      }

      async worker() {
        while (this.isRunning) {
          const segmentIndex = this.downloadQueue.shift();
          
          if (segmentIndex === undefined) {
            await new Promise(resolve => setTimeout(resolve, 100));
            continue;
          }
          
          if (videoState.segments[segmentIndex] || this.activeDownloads.has(segmentIndex)) {
            continue;
          }
          
          this.activeDownloads.add(segmentIndex);
          
          try {
            // Th√™m delay nh·ªè ƒë·ªÉ tr√°nh spam
            await new Promise(resolve => setTimeout(resolve, CONFIG.REQUEST_DELAY));
            
            const segmentData = await downloadSegment(segmentIndex);
            videoState.segments[segmentIndex] = segmentData;
            
            // C·∫≠p nh·∫≠t buffer count (li√™n t·ª•c t·ª´ ƒë·∫ßu)
            this.updateBufferCount();
            this.updateUI();
            
            // Th√™m segment ti·∫øp theo v√†o queue n·∫øu c·∫ßn
            this.manageQueue();
            
          } catch (error) {
            console.error(`Worker failed for segment ${segmentIndex}:`, error);
          } finally {
            this.activeDownloads.delete(segmentIndex);
          }
        }
      }

      updateBufferCount() {
        let count = 0;
        for (let i = 0; i < CONFIG.TOTAL_SEGMENTS; i++) {
          if (videoState.segments[i]) {
            count = i + 1;
          } else {
            break;
          }
        }
        videoState.bufferedCount = count;
      }

      manageQueue() {
        // Th√™m segment ti·∫øp theo n·∫øu c·∫ßn
        const nextIndex = Math.max(videoState.bufferedCount, videoState.currentSegment + CONFIG.LOOKAHEAD_BUFFER);
        
        if (nextIndex < CONFIG.TOTAL_SEGMENTS && !this.downloadQueue.includes(nextIndex)) {
          this.downloadQueue.push(nextIndex);
        }
      }

      updateUI() {
        const progress = Math.floor((videoState.bufferedCount / CONFIG.TOTAL_SEGMENTS) * 100);
        elements.progressFill.style.width = progress + '%';
        elements.progressText.textContent = progress + '%';
        
        // Update buffer indicator
        if (videoState.bufferedCount >= CONFIG.INITIAL_BUFFER) {
          elements.bufferIndicator.textContent = 'S·∫µn s√†ng ph√°t';
          elements.bufferIndicator.classList.add('ready');
        } else {
          elements.bufferIndicator.textContent = `ƒêang t·∫£i... ${videoState.bufferedCount}/${CONFIG.INITIAL_BUFFER}`;
          elements.bufferIndicator.classList.remove('ready');
        }
        
        // Update speed indicator
        const elapsed = (Date.now() - videoState.downloadStats.startTime) / 1000;
        if (elapsed > 0) {
          const speed = videoState.downloadStats.totalBytes / elapsed;
          elements.speedIndicator.textContent = formatSpeed(speed);
        }
      }

      stop() {
        this.isRunning = false;
      }
    }

    // T·∫°o video t·ª´ segments
    async function createVideo() {
      try {
        elements.loadingText.textContent = 'ƒêang x·ª≠ l√Ω video...';
        
        // L·∫•y c√°c segment li√™n t·ª•c t·ª´ ƒë·∫ßu
        const validSegments = [];
        for (let i = 0; i < videoState.bufferedCount; i++) {
          if (videoState.segments[i]) {
            validSegments.push(videoState.segments[i]);
          }
        }
        
        if (validSegments.length === 0) {
          throw new Error('Kh√¥ng c√≥ segment n√†o ƒë·ªÉ t·∫°o video');
        }
        
        // Gh√©p segments
        const totalLength = validSegments.reduce((sum, seg) => sum + seg.length, 0);
        const combined = new Uint8Array(totalLength);
        
        let offset = 0;
        for (const segment of validSegments) {
          combined.set(segment, offset);
          offset += segment.length;
        }
        
        console.log(`ƒê√£ gh√©p ${validSegments.length} segments, t·ªïng ${formatBytes(totalLength)}`);
        
        // Load FFmpeg n·∫øu ch∆∞a load
        if (!ffmpeg.isLoaded()) {
          elements.loadingText.textContent = 'ƒêang t·∫£i FFmpeg...';
          await ffmpeg.load();
        }
        
        // X·ª≠ l√Ω v·ªõi FFmpeg
        elements.loadingText.textContent = 'ƒêang chuy·ªÉn ƒë·ªïi...';
        
        ffmpeg.FS('writeFile', 'input.ts', combined);
        
        await ffmpeg.run(
          '-i', 'input.ts',
          '-c:v', 'copy',
          '-c:a', 'aac', 
          '-bsf:a', 'aac_adtstoasc',
          '-f', 'mp4',
          '-movflags', 'frag_keyframe+empty_moov',
          'output.mp4'
        );
        
        const mp4Data = ffmpeg.FS('readFile', 'output.mp4');
        const blob = new Blob([mp4Data.buffer], { type: 'video/mp4' });
        const videoUrl = URL.createObjectURL(blob);
        
        // Set video source
        elements.video.src = videoUrl;
        
        // Cleanup FFmpeg files
        try {
          ffmpeg.FS('unlink', 'input.ts');
          ffmpeg.FS('unlink', 'output.mp4');
        } catch (e) {
          console.warn('Cleanup warning:', e);
        }
        
        return videoUrl;
        
      } catch (error) {
        console.error('L·ªói t·∫°o video:', error);
        throw error;
      }
    }

    // Kh·ªüi ƒë·ªông t·∫£i video
    async function startVideoLoad() {
      if (videoState.isLoading) return;
      
      videoState.isLoading = true;
      videoState.downloadStats.startTime = Date.now();
      
      // Hi·ªÉn th·ªã loading
      elements.playButton.style.display = 'none';
      elements.loadingContent.style.display = 'block';
      elements.errorMessage.classList.add('hidden');
      
      try {
        // T·∫£i header
        elements.loadingText.textContent = 'ƒêang t·∫£i header...';
        await loadHeader();
        
        // B·∫Øt ƒë·∫ßu t·∫£i segments
        elements.loadingText.textContent = 'ƒêang t·∫£i video...';
        const downloadManager = new DownloadManager();
        
        // B·∫Øt ƒë·∫ßu t·∫£i background
        downloadManager.start();
        
        // Ch·ªù buffer ƒë·ªß ƒë·ªÉ ph√°t
        while (videoState.bufferedCount < CONFIG.INITIAL_BUFFER) {
          await new Promise(resolve => setTimeout(resolve, 500));
        }
        
        // T·∫°o video
        await createVideo();
        
        // ·∫®n loading overlay
        elements.loadingOverlay.classList.add('hidden');
        
        // T·ª± ƒë·ªông ph√°t
        try {
          await elements.video.play();
          videoState.isPlaying = true;
          updatePlayButton();
        } catch (e) {
          console.log('Autoplay blocked, user needs to click play');
        }
        
        console.log('Video ready to play!');
        
      } catch (error) {
        console.error('L·ªói t·∫£i video:', error);
        elements.loadingContent.style.display = 'none';
        elements.errorMessage.classList.remove('hidden');
        elements.errorMessage.textContent = 'C√≥ l·ªói x·∫£y ra: ' + error.message;
        
        // Hi·ªÉn th·ªã l·∫°i play button ƒë·ªÉ th·ª≠ l·∫°i
        elements.playButton.style.display = 'flex';
      }
      
      videoState.isLoading = false;
    }

    // C·∫≠p nh·∫≠t n√∫t play/pause
    function updatePlayButton() {
      const isPlaying = !elements.video.paused;
      elements.playPauseBtn.innerHTML = isPlaying ? 
        '<svg viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>' :
        '<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>';
    }

    // Event listeners
    elements.playButton.addEventListener('click', startVideoLoad);

    elements.playPauseBtn.addEventListener('click', () => {
      if (elements.video.paused) {
        elements.video.play();
      } else {
        elements.video.pause();
      }
    });

    elements.video.addEventListener('play', () => {
      videoState.isPlaying = true;
      updatePlayButton();
    });

    elements.video.addEventListener('pause', () => {
      videoState.isPlaying = false;
      updatePlayButton();
    });

    elements.video.addEventListener('timeupdate', () => {
      const current = elements.video.currentTime;
      const duration = elements.video.duration;
      
      if (duration) {
        const progress = (current / duration) * 100;
        elements.videoProgressFill.style.width = progress + '%';
        elements.timeDisplay.textContent = `${formatTime(current)} / ${formatTime(duration)}`;
      }
    });

    elements.videoProgress.addEventListener('click', (e) => {
      const rect = elements.videoProgress.getBoundingClientRect();
      const clickX = e.clientX - rect.left;
      const progress = clickX / rect.width;
      elements.video.currentTime = progress * elements.video.duration;
    });

    // Mute button
    elements.muteBtn = document.getElementById('muteBtn');
    elements.muteBtn.addEventListener('click', () => {
      elements.video.muted = !elements.video.muted;
      elements.muteBtn.innerHTML = elements.video.muted ?
        '<svg viewBox="0 0 24 24"><path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/></svg>' :
        '<svg viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>';
    });

    console.log('üé¨ Video Player initialized - Click play to start!');
  </script>
</body>
</html>
